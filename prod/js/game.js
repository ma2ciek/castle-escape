/*! castle-escape 2015-06-09 */
function init(){canvas=document.getElementsByTagName("CANVAS")[0],ctx=canvas.getContext("2d"),addAdditionalfunctionsToCtx(ctx),activeObjects=new ActiveObjectsManager(canvas),activeObjects.watch(),AORenderer=new ActiveObjectsRenderer(ctx,activeObjects),settings=new Settings,audioManager=new AudioManager,user=new User,game=new Game}function addAdditionalfunctionsToCtx(a){a.roundRect=function(a,b,c,d,e,f,g){void 0===g&&(g=!0),e||(e=5),this.beginPath(),this.moveTo(a+e,b),this.lineTo(a+c-e,b),this.quadraticCurveTo(a+c,b,a+c,b+e),this.lineTo(a+c,b+d-e),this.quadraticCurveTo(a+c,b+d,a+c-e,b+d),this.lineTo(a+e,b+d),this.quadraticCurveTo(a,b+d,a,b+d-e),this.lineTo(a,b+e),this.quadraticCurveTo(a,b,a+e,b),this.closePath(),g&&this.stroke(),f&&this.fill()},a.circle=function(a,b,c,d,e){return this.beginPath(),d&&(this.fillStyle=d),this.arc(a,b,c,0,2*Math.PI,!1),this.fill(),e&&(this.strokeStyle=e,this.stroke()),this},a.style=function(b){extend(a,b)},a.drawRect=function(a,b,c,d,e,f){e&&(this.fillStyle=e),this.fillRect(a,b,c,d),f&&(this.strokeStyle=f,this.strokeRect(a,b,c,d))},a.handDrawnText=function(a,b,c,d,e,f,g){function h(a){a.lineWidth=l,a.textAlign="left",a.save(),a.font=n,a.lineJoin="round",a.globalAlpha=o,a.textBaseline="hanging",a.setLineDash([i-j,j-k]),a.strokeStyle=d}var i=220,j=i,k=15,l=this.lineWidth=3,m=50,n=this.font=m+"px Comic Sans MS, cursive, TSCu_Comic, sans-serif",o=.2,p=0,q=function(){},r=this;return r.textAlign="left",e=e||"#000",d=d||"rgba(0, 0, 0, 0.5)",f===!0&&(b-=(this.measureText(a).width+l*a.length/2)/2,console.log(b)),g&&" "!==a[p]&&g.cloneNode().play(),function s(){h(r),j-=k,r.strokeText(a[p],b,c),j>0?requestAnimationFrame(s):(r.fillStyle=e,r.fillText(a[p],b,c),j=i,b+=r.measureText(a[p++]).width+l*Math.random(),r.setTransform(1,0,0,1,0,4*Math.random()),p<a.length?(g&&" "!==a[p]&&g.cloneNode().play(),requestAnimationFrame(s)):q()),r.restore()}(),{next:function(a){q=a},wait:function(a,b){q=function(){window.setTimeout(b,a)}}}}}function createArray(a){var b=new Array(a||0),c=a;if(arguments.length>1)for(var d=[].slice.call(arguments,1);c--;)b[a-1-c]=createArray.apply(this,d);return b}function extend(a){for(var b=Array.prototype.splice.call(arguments,1),c=0;c<b.length;c++){var d=b[c];for(var e in d)a[e]=d[e]}return a}function loadJSON(){function a(){0===--l&&(0===g.length?j&&j.apply(this,i):k&&k.apply(this,g))}function b(b,d){if(200===b.status){var e=b.response;i[d]=e,a()}else c(d)}function c(b){g.push(h[b]),a()}function d(a){var d=new XMLHttpRequest;d.open("GET",h[a],!0),d.send(null),d.responseType="json",d.onload=function(){b(this,a)},d.onerror=function(){c(a)}}function e(a){return j=a,this}function f(a){return k=a,this}for(var g=[],h=[].slice.call(arguments),i=new Array(h.length),j=null,k=null,l=h.length,m=0;m<h.length;m++)d(m);return{then:e,fail:f}}function ActiveObjectsManager(a){this._canvas=a,this._list=[],this._selected=null,this._hover=null,this._mousePos={x:0,y:0}}function ActiveObject(a,b){this._manager=a,this._data={},this._classes={},this._setDimensions(b),this._setEventListeners(b),this._setOffset(b)}function ActiveObjectsRenderer(a,b){this._ctx=a,this._AOManager=b}function Animation(a){extend(this,new EventEmitter),a=a||{},this._size=a.size,this._createFrames(a),this._timeStamp=0,this._frameIndex=a.startIndex||0,this._frameLooped=a.frameLooped||!1,this._frameDuration=a.frameDuration||3,this._priorytet=a.priorytet||0,this._audioLooped=a.audioLooped||!1}function Assignments(){extend(this,new EventEmitter),this._list={},this._keys={},this._activeBinding=null,this._setKeyNames(),this._setDefaultAssignments(),this._loadAssignmentsFromStorage()}function AudioManager(){extend(this,new EventEmitter),this._list={},this._waiting=0,this._loadSettings(),this._setSettingsChangeListener()}function BgAudio(){this._bgAudio=null}function Board(){this._scenes=[],extend(this,new EventEmitter),this.imgManager=new ImageManager,this.width=window.innerWidth,this.height=window.innerHeight,this.resize();var a=this;this.imgManager.add({"castle-in-clouds":"./img/castle-in-clouds.png"})._addEventListener("loaded",function(){a.redrawScenes()})}function DocumentQuery(){var a=[];if("object"==typeof arguments[0]){for(var b=0;b<arguments.length;b++){var c=arguments[b];if(c.length)for(var d=0;d<c.length;d++)a=a.concat(c[d]);else a=a.concat(c)}return new DocumentObjectsManager(a)}var e=document.createElement(arguments[0]);return new DocumentObjectsManager([e])}function DocumentObjectsManager(a){for(var b=0;b<a.length;b++)this[b]=a[b];this._elements=a}function EventEmitter(){this._events={}}function Timeline(){this._timeEvents={},this._frame=0}function Game(){BgAudio.call(this),extend(this,new EventEmitter),this._board=new Board,this._loadAudio()}function GameObject(a,b){switch(extend(this,new EventEmitter),b.name){}extend(this,b)}function ImageManager(){extend(this,new EventEmitter),this._counter=0,this._list={}}function Player(a){var b=this;this._world=a,this.x=1265,this.y=2140,this.Vy=0,this.width=48,this.height=92,this.speed=7,this.shadowRelativePosition={get x(){return b.x+23},get y(){return b.y+15},get width(){return 20},get height(){return 67}},this.jumpHeight=20,this.isOnLadder=!1,extend(this,new EventEmitter),extend(this,GameObject.prototype),this._setAnimation()}function Scene(a,b){extend(this,new EventEmitter),this._board=a,this._isVivible=!!b.isVivible,this._zIndex=b.zIndex||0,this._setDimensions(a,b),this._setOffset(a,b),this._bgColor=b.bgColor||null,b.bgImage&&(this._bgImage=a.imgManager[b.bgImage]),this._objects={},this._sortedObjects=[];for(var c in b.objects)this._objects[c]=new SceneObject(this,c,b.objects[c]);this._sortObjects()}function SceneObject(a,b,c){this._scene=a,this._objName=b,this._hoverStyles={},this._addClassesStyles(c,b),this._setEventListeners(c,b),this._setDimensions(c),this._setShape(c),this._setBgImage(c),this._zIndex=(c.zIndex||0)+this._scene.attr("zIndex"),this._setText(c),this._createActiveObjectFromSelf()}function Settings(){extend(this,new EventEmitter),this._options={},this._storageOptions={},this.setDefaultOptions(),this._assignments=new Assignments,this._loadSettingsFromStorage()}function SettingsGUI(a){this._div=$("div").html(a)[0],this._div.id="settings",document.body.appendChild(this._div),this._actionsList={},this._assignments=settings.getAssignments();for(var b=document.getElementsByTagName("li"),c=this,d=0;d<b.length;d++)b[d].addEventListener("click",c._selectMenuClickHandler.bind(c));b[0].click()}function User(){this.lang=navigator.language||navigator.userLanguage||"pl",this.cores=navigator.hardwareConcurrency||4,this.touchPoints=navigator.maxTouchPoints,this.keys={},this._setEventListeners(),this.actions={}}function World(a){this._game=a,this._layers=[],this._tileSets=[],this._sprites={},this._objects=[],this._objectsOnScreen=[],this._objectTypes=[],this._loadData(),extend(this,new EventEmitter)}function TileSet(a){extend(this,a),this.load()}function relativate(a,b){return{x:Math.floor(a-game._player.x-game._player.width/2+game._board.width/2),y:Math.floor(b-game._player.y-game._player.width/2+game._board.height/2)}}document.addEventListener("init",function(){init()});var canvas,ctx,user,audioManager,settings,game,activeObjects,AORenderer,fps=function(){function a(a,b){var c=e;a.textAlign=c.textAlign,a.textBaseline=c.textBaseline,a.fillStyle=c.fillStyle,a.font=c.fontSize+"px "+c.fontFamily,a.fillText("FPS:"+b,c.left,c.top)}var b=[0],c=0,d=Date.now(),e={left:0,top:0,fontSize:15,fontFamily:"Verdana",maxLength:60,fillStyle:"black",textBaseline:"top",textAlign:"left"};return{count:function(f){var g=Date.now()-d;d=Date.now(),b.length>e.maxLength&&(c-=b.pop()),b.unshift(g),c+=g;var h=1e3/(c/b.length)|0;a(f,h)},set:function(a){if("object"!=typeof a)throw new Error("Wrong data type");for(var b in a){if(!e.hasOwnProperty(b))throw new Error("Wrong option name");void 0!==a[b]&&(e[b]=a[b])}}}}();Date.now=Date.now||function(){return+new Date},Math.sign=Math.sign||function(a){return 0===a?0:a/Math.abs(a)},Array.prototype.includes=Array.prototype.includes||function(a){return-1!==this.indexOf(a)};var _p=ActiveObjectsManager.prototype;_p.add=function(a){var b=new ActiveObject(this,a);return this._list.push(b),b},_p.get=function(a,b){for(var c=-(1/0),d=null,e=this._list,f=0;f<e.length;f++){var g=e[f];switch(g.shape){case"rect":g.x<=a&&g.x+g.width>=a&&g.y<=b&&g.y+g.height>=b&&g.zIndex>c&&(d=g,c=g.zIndex);break;case"arc":(g.x-a)*(g.x-a)+(g.y-b)*(g.y-b)<=g.radius*g.radius&&g.zIndex>c&&(d=g,c=g.zIndex);break;default:throw new TypeError("Wrong shape")}}return d},_p.getSelected=function(){return this._selected},_p.getHover=function(){return this._hover},_p.getAll=function(){return this._list},_p.filter=function(a){for(var b=[],c=0;c<this._list.length;c++){var d=this._list[c],e=a.call(d,d);e&&b.push(d)}return b},_p.each=function(a){for(var b=0;b<this._list.length;b++){var c=this._list[b];a.call(c,c)}},_p.remove=function(a){var b=this._list.indexOf(a);this._list.splice(b,1)},_p.removeAll=function(){this._list.length=0,this._hover=null},_p.watch=function(){var a=this;window.addEventListener("mousedown",a._mouseClick.bind(a)),this._canvas.addEventListener("mousemove",a._mouseMove.bind(a)),this._canvas.addEventListener("mouseleave",a._mouseLeaveCanvas.bind(a))},_p.unwatch=function(){var a=this;window.removeEventListener("mousedown",a._mouseClick),this._canvas.removeEventListener("mousemove",a._mouseMove),this._canvas.removeEventListener("mouseleave",a._mouseLeaveCanvas)},_p._mouseClick=function(a){var b=this._getCursorPosition(a),c=this.get(b.x,b.y);if("CANVAS"===a.target.nodeName)if(1===a.which){var d=this._selected;c!=d&&d&&"function"==typeof d.onBlur&&d.onBlur(),c&&"function"==typeof c.leftClick&&c.leftClick(a),this._selected=c}else if(3===a.which)return c&&"function"==typeof c.rightClick&&c.rightClick(a),this._selected=null,!1},_p._mouseMove=function(a){var b=this._getCursorPosition(a);if(this._hover!==this.get(b.x,b.y)){var c=this._hover,d=this._hover=this.get(b.x,b.y);c&&"function"==typeof c.onMouseOut&&c.onMouseOut(),d&&"function"==typeof d.onHover&&d.onHover(a)}this._mousePos=b},_p._mouseLeaveCanvas=function(){this._hover=null},_p._getCursorPosition=function(a){return{x:a.pageX-a.target.offsetLeft,y:a.pageY-a.target.offsetTop}};var _p=ActiveObject.prototype;_p._setDimensions=function(a){this.radius=a.radius,this.width=a.width,this.height=a.height,this.shape=a.shape||"rect",this.zIndex=a.zIndex||0},_p._setEventListeners=function(a){this.leftClick=a.leftClick||null,this.rightClick=a.rightClick||null,this.onHover=a.onHover||null,this.onBlur=a.onBlur||null,this.onMouseOut=a.onMouseOut||null},_p._setOffset=function(a){this.x=a.left||a.x||0,this.y=a.top||a.y||0,this.fromCenter=a.fromCenter||!1,this.fromCenter||"arc"!==this.shape||(this.x+=this.radius,this.y+=this.radius),this.fromCenter&&"rect"===this.shape&&(this.x-=this.width/2,this.y-=this.height/2)},_p.centerX=function(){return this.x+this.width/2},_p.centerY=function(){return this.y+this.height/2},_p.remove=function(){this._manager.remove(this)},_p.data=function(){var a=arguments;switch(a.length){case 0:return this._data;case 1:if("object"!=typeof a[0])return this._data[a[0]];for(var b in a[0]){var c=a[0][b];this._data[b]=c}break;case 2:this._data[a[0]]=a[1];break;default:throw new Error("Too many arguments")}},_p.addClass=function(a,b){this._classes[a]=b},_p.removeClass=function(a){delete this._classes[a]},_p.getClasses=function(){return this._classes};var _p=ActiveObjectsRenderer.prototype;_p.renderAll=function(){for(var a=this._AOManager.getAll(),b=0;b<a.length;b++){var c=a[b];this.renderActiveObject(c)}},_p.renderActiveObject=function(a){var b=this._isHover(a),c=a.getClasses(),d=extend({},this._defaultStyle,a.data());b&&extend(d,a.data("hover"));for(var e in c){var f=c[e];extend(d,f)}d.bgColor&&this._drawBackground(a,d),d.innerText&&this._drawText(a,d)},_p._isHover=function(a){return a===this._AOManager.getHover()&&"undefined"!=typeof a.data("hover")},_p._drawBackground=function(a,b){this._ctx.fillStyle=b.bgColor,this._ctx.fillRect(a.x,a.y,a.width,a.height)},_p._drawText=function(a,b){var c=b.innerText;this._ctx.textBaseline=b.textBaseline,this._ctx.font=b.textFont,this._ctx.fillStyle=b.textColor,this._ctx.textAlign=b.textAlign;var d;switch(b.textAlign){case"left":d=a.x;break;case"center":d=a.x+a.width/2;break;case"right":d=a.x+a.width;break;default:throw new Error("No such option")}var e=this._ctx.measureText("M").width,f=a.y+(a.height-e)/2;this._ctx.fillText(c,d,f)},_p._defaultStyle={textBaseline:"hanging",textColor:"#000",textFont:"15px Arial",textAlign:"center"},_p.renderScene=function(a){for(var b=this._AOManager.filter(function(){return this.data("scene")===a}),c=0;c<b.length;c++){var d=b[c];console.log(d),this.renderActiveObject(d)}};var _p=Animation.prototype;_p.setAudio=function(a){this._audio=a.cloneNode(),this._audio.addEventListener("ended",this._onAudioEnded)},_p._onAudioEnded=function(){this._audioLooped&&this._audio.play(),this._trigger("audioEnded")},_p._createFrames=function(a){var b,c=a.offsetLeft||0,d=a.offsetTop||0;if(this.frames=[],"column"===a.frameDirection)for(b=0;b<a.size;b++)this.frames[b]={width:a.frameWidth,height:a.frameHeight,image:a.image,x:c,y:a.frameHeight*b+d};else for(b=0;b<a.size;b++)this.frames[b]={width:a.frameWidth,height:a.frameHeight,image:a.image,x:a.frameWidth*b+c,y:d}},_p.setFrameIndex=function(a){this._frameIndex=a},_p.getPrirytet=function(){return this._priorytet},_p.nextFrame=function(){this._timeStamp+this._frameDuration<game.getFrameIndex()&&(this._timeStamp=game.getFrameIndex(),this._frameIndex<this._size-1?this._frameIndex++:this._frameLooped?this._frameIndex=0:(this._end=1,this._trigger("animationEnd")))},_p.getCurrentFrame=function(){var a=this.frames[this._frameIndex];return{image:a.image,x:a.x,y:a.y,width:a.width,height:a.height}},Assignments.prototype.getList=function(){return this._list},Assignments.prototype.getCodeFromAction=function(a){var b=this._list[a];for(var c in this._keys)if(this._keys[c]===b)return c},Assignments.prototype.getActionFromCode=function(a){var b=this._keys[a];for(var c in this._list)if(this._list[c]==b)return c},Assignments.prototype.getKeyName=function(a){return this._list[a]},Assignments.prototype.setActiveBinding=function(a){this._activeBinding=a},Assignments.prototype._setKeyNames=function(){var a,b={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps lock",27:"Escape",32:"Space",33:"Page up",34:"Page down",35:"End",36:"Home",37:"Left arrow",38:"Up arrow",39:"Right arrow",40:"Down arrow",45:"Insert",46:"Delete",91:"Left window key",92:"Right window key",93:"Select key",144:"Num lock",145:"Scroll lock",186:"Semicolon",187:"Equal sign",188:"Comma",189:"Dash",190:"Period",191:"Forward slash",192:"Grave accent",219:"Open bracket",220:"Back slash",221:"Close bracket",222:"Quote",255:"Fn"};for(a=48;57>=a;a++)b[a]=String.fromCharCode(a);for(a=65;90>=a;a++)b[a]=String.fromCharCode(a);for(a=96;105>=a;a++)b[a]="Numpad "+(a-96);for(a=112;123>=a;a++)b[a]="F"+(a-111);this._keys=b},Assignments.prototype._loadAssignmentsFromStorage=function(){var a=window.localStorage.getItem("Castle_Ecape_Bindings")||"{}",b=JSON.parse(a);for(var c in b)this._list[c]=b[c]},Assignments.prototype.tryBind=function(a){var b=this._keys[a];for(var c in this._list)if(c===this._activeBinding)return this._list[c]=b||"",this._removeAssignmentNotFrom(b,c),this._saveAssignmentToStorage(),this._trigger("changeAssignnment",c),!0},Assignments.prototype._removeAssignmentNotFrom=function(a,b){for(var c in this._list)if(this._list[c]===a&&b!=c){this._list[c]="",this._trigger("changeAssignnment",c);break}},Assignments.prototype._saveAssignmentToStorage=function(){var a=JSON.stringify(this._list);window.localStorage.setItem("Castle_Ecape_Bindings",a)},Assignments.prototype._setDefaultAssignments=function(){var a={"Move Left":"Left arrow","Move Right":"Right arrow","Climb Up":"Up arrow","Climb Down":"Down arrow",Jump:"Space",Attack:"Alt",Inventory:"I",Settings:"Escape"};for(var b in a)this._list[b]=a[b],this._trigger("changeAssignnment",b)};var _p=AudioManager.prototype;_p.add=function(a){var b=Object.keys(a).length;this._waiting+=b;for(var c in a){var d=a[c],e=new Audio;e.name=c,e.src=d.src,e.localVolume=d.volume?d.volume/100:1,e.volume=this._globalVolume*e.localVolume,d.loop&&!d.once&&e.addEventListener("ended",this.play);var f=this._canplaythrough.bind(this,e,d,c);e.addEventListener("canplaythrough",f),e.onerror=this._onerror}return this},_p._loadSettings=function(){var a={AUDIO_VOLUME:"_globalVolume"};for(var b in a){var c=a[b],d=settings.getPropValue(b);this[c]=d}},_p._setSettingsChangeListener=function(){var a={AUDIO_VOLUME:"_changeGlobalVolume"};settings._addEventListener("change",function(b,c){var d=a[b];this[d].call(this,c)}.bind(this))},_p._canplaythrough=function(a,b,c){this._list[c]=a,this._loaded()},_p._onerror=function(a){console.error("Cannot load this file: "+a.src),this._loaded()},_p.get=function(a){return a in this._list?this._list[a]:void console.error("Missing audio file: "+a)},_p._loaded=function(){console.log(this._waiting),this._waiting--,0===this._waiting&&this._trigger("audioLoaded")},_p._changeGlobalVolume=function(a){this._globalVolume=a;for(var b in this._list)this._list[b].volume=this._list[b].localVolume*a},BgAudio.prototype._setBgAudio=function(a){if(this._bgAudio){if(this._bgAudio.name===a)return;this._bgAudio.pause()}try{this._bgAudio=audioManager.get(a),this._bgAudio.currentTime=0,this._bgAudio.play()}catch(b){console.error(b)}},Board.prototype.resize=function(){function a(){b.width=canvas.width=document.documentElement.clientWidth||document.body.clientWidth,b.height=canvas.height=document.documentElement.clientHeight||document.body.clientHeight,b.redrawScenes()}var b=this;window.addEventListener("resize",a),a()},Board.prototype.clear=function(){ctx.fillStyle="#000",ctx.fillRect(0,0,this.width,this.height)},Board.prototype.drawScenes=function(){for(var a=0;a<this._scenes.length;a++)this._scenes[a].draw()},Board.prototype.redrawScenes=function(){ctx.clearRect(0,0,this.width,this.height),this.drawScenes()},Board.prototype._addScene=function(a){var b=this;this._scenes.push(a),this._scenes.sort(function(a,b){return a.zIndex-b.zIndex}),a._addEventListener("dirt",b.redrawScenes.bind(b)),this.redrawScenes()},Board.prototype._removeScene=function(a){a.remove(),this._scenes.splice(this._scenes.indexOf(a)),this.redrawScenes()},Board.prototype.removeScenes=function(){for(var a=0;a<this._scenes.length;a++)this._scenes[a].remove();this._scenes.length=0},Board.prototype.createWelcomeScene=function(){this._addScene(new Scene(this,{objects:{castleImage:{},title:{},sky:{},ground:{},HOME_author:{},play:{onClick:function(){location.hash="play"}},resume:{onClick:function(){location.hash="continue"}},credits:{onClick:function(){location.hash="credits"}},settings:{onClick:function(){location.hash="settings"}}}}))},Board.prototype.createSettingsScene=function(){var a=this,b=new XMLHttpRequest;b.onload=function(){var b=this.response;a.settingsGUI=new SettingsGUI(b)},b.open("GET","html/settings/index.html"),b.send();var c=new XMLHttpRequest;c.onload=function(){var a=$("style")[0];a.innerHTML=this.response,a.id="settings-style",document.head.appendChild(a)},c.open("GET","./html/settings/style.css"),c.send()},Board.prototype.createCreditsScene=function(){this._addScene(new Scene(this,{bgColor:"#000",zIndex:6,objects:{bg:{onClick:function(){location.hash=""}},author:{onClick:function(){location.href="http://www.google.com"}},graphics:{}}}))};var $=DocumentQuery,_p=DocumentObjectsManager.prototype;_p.valueOf=function(){return this._elements},_p._each=function(a){for(var b=0;b<this._elements.length;b++){var c=this._elements[b];a.call(c,c)}},_p.addClass=function(a){return this._each(function(b){b.className+=b.className?" "+a:a}),this},_p.removeClass=function(a){return this._each(function(b){var c=new RegExp("\\s*"+a+"\\s*","g");b.className=b.className.replace(c," ")}),this},_p.hasClass=function(a){var b=this._elements[0],c=new RegExp(a,"g");return c.test(b.className)},_p.hide=function(a,b){var c=this;return this._each(function(d){var e=a?30/a:.04,f=""===d.style.opacity?1:parseFloat(d.style.opacity);d.style.opacity=Math.max(0,f-e),d.style.opacity>0?window.setTimeout(c.hide.bind(c,a,b),30):b&&b()}),this},_p.show=function(a,b,c){var d=this;return this._each(function(a){var e=b?30/b:.04,f=""===a.style.opacity?1:parseFloat(a.style.opacity);a.style.opacity=Math.min(1,f+e),a.style.opacity<1?window.setTimeout(d.show.bind(d,b,c),30):c&&c()}),this},_p.html=function(a){return this._each(function(b){b.innerHTML=a}),this},_p.remove=function(){this._each(function(a){a.outerHTML=""})},EventEmitter.prototype._addEventListener=function(a,b){this._events[a]||(this._events[a]=[]),"function"!=typeof b&&console.error("eventHandler must be a function"),this._events[a].push(b.bind(this))},EventEmitter.prototype._trigger=function(a){var b=this._events[a];if(b)for(var c=Array.prototype.slice.call(arguments,1),d=0;d<b.length;d++)b[d].apply(this,c)},EventEmitter.prototype._removeEventListener=function(a,b){if("undefined"!=typeof this._events[a]){var c=this._events[a].indexOf(b);if(console.log(b,this._events),-1!==c)return this}},EventEmitter.prototype._dispatch=function(a){a in this._events&&(this._events[a].length=0)},EventEmitter.prototype._getEventListeners=function(a){return this._events[a]},Timeline.prototype.getCurrentFrameIndex=function(){return this._frame},Timeline.prototype.addEvent=function(a,b,c){a+=this._frame,this._timeEvents[a]||(this._timeEvents[a]=[]),this._timeEvents[a].push(b.bind(c))},Timeline.prototype.showEvents=function(){return this._timeEvents},Timeline.prototype.check=function(){var a=this._timeEvents[this._frame];if(a){for(var b=0;b<a.length;b++)a[b].call(this);delete this._timeEvents[this._frame]}},Timeline.prototype.getFrameIndex=function(){return this._frame},extend(Game.prototype,BgAudio.prototype),Game.prototype._loadAudio=function(){var a=this;loadJSON("data/audio.json").then(function(b){audioManager.add(b),audioManager._addEventListener("audioLoaded",a.onAudioLoaded.bind(a))})},Game.prototype.onAudioLoaded=function(){console.log(audioManager._list),this._setNavigation()},Game.prototype.play=function(){extend(this,new Timeline),this._pause=!1,this._world=new World(this);var a=this;a._setBgAudio("game-music"),this._world._addEventListener("loaded",function(){a._player=new Player(this),a._nextFrame()})},Game.prototype.pause=function(){this._pause=!0,this._bgAudio&&this._bgAudio.pause()},Game.prototype.resume=function(){this._pause=!1,this._nextFrame(),this._bgAudio&&this._bgAudio.play()},Game.prototype._nextFrame=function(){try{this._frame++,this.check(),this._player.move(),this._board.clear(),this._world.drawLayers(),this._world.drawObjects(),this._board.drawScenes(),fps.count(ctx),this._pause||window.requestAnimationFrame(this._nextFrame.bind(this))}catch(a){console.log(a)}},Game.prototype.goToStartPage=function(){this._setBgAudio("start-music"),this._board.createWelcomeScene()},Game.prototype.goToCreditsPage=function(){this._setBgAudio("start-music"),this._board.createCreditsScene()},Game.prototype.goToSettingsPage=function(){this._setBgAudio("start-music"),this._board.createSettingsScene()},Game.prototype._setNavigation=function(){function a(a){a&&(a.preventDefault(),a.stopPropagation()),b._pause=!0,b._board.removeScenes(),activeObjects.removeAll();var c=0===location.hash.length?"":location.hash.slice(1);switch(c){case"play":b.play();break;case"":b.goToStartPage();break;case"credits":b.goToCreditsPage();break;case"resume":break;case"settings":b.goToSettingsPage();break;default:console.error(c)}}var b=this;window.addEventListener("hashchange",a),a()},GameObject.prototype.draw=function(){var a=this.animations[this.currentAnimationName],b=relativate(this.x,this.y),c=a.getCurrentFrame();ctx.drawImage(c.image,c.x,c.y,c.width,c.height,b.x,b.y,c.width,c.height)};var _p=ImageManager.prototype;_p.add=function(a){for(var b in a){this._counter++;var c=this._list[b]=new Image;c.src=a[b],c.onload=this._onload.bind(this,b,c.src),c.onerror=this._onerror.bind(this,b,c.src)}return this},_p._onload=function(){this._count()},_p._onerror=function(a,b){this._trigger("error"),console.error(a,b),this._count()},_p._count=function(){this._counter--,0===this._counter&&this._trigger("loaded")},_p.get=function(a){return this._list[a]};var _p=Player.prototype;_p._setAnimation=function(){this.frameSets=["moveDown","moveDownLeft","moveLeft","moveUpLeft","moveUp","moveUpRight","moveRight","moveDownRight"];var a=this,b=3,c=48,d=92,e=9;this.animations={},this.currentAnimationName=this.frameSets[0],this.ready=!1,this.image=new Image,this.image.src="img/walk-cycle.png",this.image.addEventListener("load",function(){a.frameSets.forEach(function(f,g){a.animations[f]=new Animation({image:a.image,frameWidth:c,frameHeight:d,size:e,frameLooped:!0,offsetTop:d*g,frameDuration:b})}),a.ready=!0,a._world.addObject(a)})},_p.animate=function(a){this.ready&&(this.currentAnimationName===a?this.animations[a].nextFrame():(this.currentAnimationName=a,this.animations[a].nextFrame()))},_p.move=function(){var a=0,b=0;user.actions["Climb Up"]&&b--,user.actions["Climb Down"]&&b++,user.actions["Move Left"]&&a--,user.actions["Move Right"]&&a++;var c=user.actions.Jump?!0:!1,d=3,e=this.getTilesFromCollisionWithLayer(0);this.isOnLadder&&-1!==e.indexOf(d)&&c?this._jumpFromLadder():0===b&&!this.isOnLadder||-1===e.indexOf(d)?this._moveOnGroundOrTryFall(c):this._moveOnLdder(b,d),0!==a&&this._moveAside(a)},_p._moveOnGroundOrTryFall=function(a){this.isOnLadder=!1,this.Vy++,this.y+=this.Vy;var b=this.isInCollisionWithLayer(1);if(b){for(;this.isInCollisionWithLayer(1);)this.y-=Math.sign(this.Vy);this.Vy=0,a&&this._jumpFromGround()}},_p._jumpFromLadder=function(){if(this.isOnLadder=!1,this.Vy=-this.jumpHeight,this.y+=this.Vy,this.isInCollisionWithLayer(1)){for(;this.isInCollisionWithLayer(1);)this.y-=Math.sign(this.Vy);this.Vy=0}},_p._jumpFromGround=function(){if(this.Vy-=this.jumpHeight,this.y+=this.Vy,this.isInCollisionWithLayer(1)){for(;this.isInCollisionWithLayer(1);)this.y-=Math.sign(this.Vy);this.Vy=0}},_p._moveAside=function(a){if(this.x+=this.speed*a,this.isInCollisionWithLayer(1))for(;this.isInCollisionWithLayer(1);)this.x-=a;else 1===a?this.animate("moveRight"):-1===a&&this.animate("moveLeft")},_p._moveOnLdder=function(a,b){if(this.isOnLadder=!0,this.Vy=0,this.y+=this.speed*a,this.isInCollisionWithLayer(1)||!this.getTilesFromCollisionWithLayer(0).includes(b)&&-1===a)for(;this.isInCollisionWithLayer(1)||!this.getTilesFromCollisionWithLayer(0).includes(b);)this.y-=a;else 0!==a&&this.animate("moveUp")},_p.isInCollisionWithLayer=function(a){for(var b=this.shadowRelativePosition,c=this._world._layers[a].data,d=b.y/this._world.outputTileHeight|0,e=(b.y+b.height)/this._world.outputTileHeight|0,f=(b.x-b.width/2)/this._world.outputTileWidth|0,g=(b.x+b.width/2)/this._world.outputTileWidth|0,h=f;g>=h;h++)for(var i=d;e>=i;i++){var j=i*this._world.width+h;if(0!==c[j])return!0}return!1},_p.getTilesFromCollisionWithLayer=function(a){for(var b=this.shadowRelativePosition,c=this._world._layers[a].data,d=b.y/this._world.outputTileHeight|0,e=(b.y+b.height)/this._world.outputTileHeight|0,f=(b.x-b.width/2)/this._world.outputTileWidth|0,g=(b.x+b.width/2)/this._world.outputTileWidth|0,h=[],i=f;g>=i;i++)for(var j=d;e>=j;j++){var k=j*this._world.width+i;h.push(c[k])}return h},Scene.prototype._setDimensions=function(a,b){this._height=b.height||a.height,this._width=b.width||a.width},Scene.prototype._setOffset=function(a,b){this._left=b.left||a.width-b.right||0,this._top=b.top||a.width-b.bottom||0,b.alignCenter&&(this._left=(a.width-this._width)/2),b.alignVertical&&(this._top=(a.height-this._height)/2)},Scene.prototype.getBoard=function(){return this._board},Scene.prototype.addObject=function(a,b){this._objects.push(new SceneObject(this,a,b)),this._sortObjects()},Scene.prototype._sortObjects=function(){this._sortedObjects=[];for(var a in this._objects)this._sortedObjects.push(this._objects[a]);this._sortedObjects.sort(function(a,b){return a._zIndex-b._zIndex})},Scene.prototype.draw=function(){this._bgColor&&(ctx.fillStyle=this._bgColor,ctx.fillRect(this._left,this._top,this._width,this._height)),this._bgImage&&ctx.drawImage(this._bgImage,this._left,this._top,this._width,this._height);for(var a=0;a<this._sortedObjects.length;a++)this._sortedObjects[a].draw()},Scene.prototype.attr=function(){return 1===arguments.length?this["_"+arguments[0]]:(this["_"+arguments[0]]=arguments[1],this)},Scene.prototype.remove=function(){for(var a in this._objects)this._objects[a].remove()},Scene.prototype.hide=function(){this._isVivible=!1},Scene.prototype.show=function(){this._isVivible=!0};var _p=SceneObject.prototype;_p._addClassesStyles=function(a,b){function c(b){if(b in styles)for(var d in styles[b])"extend"===d?c(styles[b].extend):a[d]=styles[b][d]}c(b)},_p._setEventListeners=function(a,b){var c=this;this._onClick=a.onClick&&a.onClick.bind(this)||null,(b+"Hover"in styles||a.onHover||a.onBlur)&&(this._setHoverStyle(b+"Hover"),this._onHover=function(){a.onHover&&a.onHover.call(c),c._hover=!0,c._scene._trigger("dirt")},this._onBlur=function(){a.onBlur&&a.onBlur.call(c),c._hover=!1,c._scene._trigger("dirt")})},_p._setHoverStyle=function(a){function b(a){if(a in styles)for(var d in styles[a])"extend"===d?b(styles[a].extend):c._hoverStyles["_"+d]=styles[a][d]}var c=this;b(a)},_p._setShape=function(a){this._shape=a.shape||"rect",this._cornerRadius=a.cornerRadius||0,this._bgColor=a.bgColor||"",this._borderWidth=a.borderWidth||0,this._borderColor=a.color||a.borderColor||"black"},_p._setBgImage=function(a){a.bgImage&&(this._bgImage=a.bgImage,this._imgWidth=a.imgWidth||a.bgImage.width,this._imgHeight=a.imgHeight||a.bgImage.height)},_p._setDimensions=function(a){this._left=(a.left||0)+this._scene.attr("left"),this._top=(a.top||0)+this._scene.attr("top"),this._width=a.width||this._scene.attr("width"),this._height=a.height||this._scene.attr("height"),a.alignCenter&&(this._left+=(this._scene.attr("width")-this._width)/2),a.alignVertical&&(this._top+=(this._scene.attr("height")-this._height)/2)},_p._setText=function(a){this._text=a.text||"",this._text&&(this._textFromLeft=(a.textFromLeft||0)+this._left,this._textFromTop=(a.textFromTop||0)+this._top,this._color=a.color||"#000",this._fontSize=a.fontSize||"12px",this._textBaseLine=a.textBaseline||"top",this._fontFamily=a.fontFamily||"Arial",this._textAlign=a.textAlign||"left")},_p._createActiveObjectFromSelf=function(){this._ao=activeObjects.add({left:this._left,top:this._top,width:this._width,height:this._height,zIndex:this._zIndex,leftClick:this._onClick,onHover:this._onHover,onBlur:this._onBlur,fromCenter:!1})},_p.draw=function(){var a=extend({},this);a._hover&&extend(a,a._hoverStyles),(a._bgColor||a._borderWidth>0)&&this._drawBackground(a),a._bgImage&&this._drawBgImage(a),a._text&&this._drawText(a)},_p._drawBackground=function(a){ctx.lineWidth=a._borderWidth,ctx.strokeStyle=a._borderColor,ctx.fillStyle=a._bgColor;var b=!!a._bgColor,c=a._borderWidth>0;"rect"===a._shape&&ctx.roundRect(a._left,a._top,a._width,a._height,a._cornerRadius,b,c)},_p._drawBgImage=function(a){var b=a._scene.getBoard().imgManager.get(a._bgImage);ctx.drawImage(b,a._left,a._top,a._imgWidth,a._imgHeight)},_p._drawText=function(a){ctx.fillStyle=a._color,ctx.font=a._fontSize+" "+a._fontFamily,ctx.textBaseline=a._textBaseLine,ctx.textAlign=a._textAlign,ctx.fillText(a._text,a._textFromLeft,a._textFromTop)},_p.remove=function(){this._ao&&this._ao.remove(),delete this._scene[this._objName]},_p.attr=function(){return 1===arguments.length?this["_"+arguments[0]]:(this["_"+arguments[0]]=arguments[1],this._scene._trigger("dirt"),this)};var styles={tile:{width:160,height:100,alignCenter:!0,top:270,color:"#6bf",textAlign:"center",fontSize:"20px",textBaseline:"middle",textFromTop:50,textFromLeft:80,zIndex:2,cornerRadius:30},tileHover:{bgColor:"#00A",
color:"#EEE",borderWidth:4},castleImage:{left:100,top:50,bgImage:"castle-in-clouds",imgWidth:400,imgHeight:390,zIndex:1},title:{left:530,top:150,width:160,zIndex:2,text:"Castle Escape",color:"#6bf",fontSize:"40px",textBaseline:"middle"},sky:{height:430,bgColor:"#05f"},ground:{top:380,height:500,bgColor:"#421"},HOME_author:{alignCenter:!0,width:100,top:700,height:40,color:"#CCC",text:"Maciej Bukowski, 2015"},play:{text:"Play",left:0,extend:"tile"},playHover:{extend:"tileHover"},resume:{left:160,text:"Continue",extend:"tile"},resumeHover:{extend:"tileHover"},credits:{text:"Credits",left:320,extend:"tile"},creditsHover:{extend:"tileHover"},settings:{text:"Settings",left:480,extend:"tile"},settingsHover:{extend:"tileHover"},author:{zIndex:3,top:100,width:400,height:50,alignCenter:!0,text:"Author: Maciej Bukowski",textFromLeft:200,textFromTop:25,fontSize:"30px",color:"#999",textAlign:"center",textBaseline:"middle"},authorHover:{color:"red"},bg:{zIndex:2},graphics:{extend:"author",top:200,text:"Graphics:",zIndex:1}},_p=Settings.prototype;_p.setDefaultOptions=function(){var a=this._options={AUDIO_VOLUME:{value:1,valueType:"number",settingsType:"audio",inputType:"range",minValue:0,maxValue:1,step:.1}};!function(){for(var b in a){var c=a[b];c.niceName=b.replace("_"," ").toLowerCase(),c.niceName=b[0]+c.niceName.substr(1)}}()},_p.getAssignments=function(){return this._assignments},_p.getPropValue=function(a){return console.log(a),this._options[a].value},_p.getAll=function(){return this._options},_p.setPropValue=function(a,b){var c=this._options[a];"number"===c.valueType&&(b=Number(b)),"boolean"===c.valueType&&(b="true"===b||b===!0||1===b||"1"===b),this._options[a].value=b,this._save(),this._trigger("change",a,b)},_p._loadSettingsFromStorage=function(){var a=localStorage.getItem("Warrior-settings")||"{}",b=JSON.parse(a);for(var c in b)c in this._options&&(this._options[c].value=b[c])},_p._save=function(){var a={};for(var b in this._options)a[b]=this._options[b].value;var c=JSON.stringify(a);localStorage.setItem("Warrior-settings",c)};var _p=SettingsGUI.prototype;_p._selectMenuClickHandler=function(a){for(var b=document.getElementsByTagName("li"),c=0;c<b.length;c++)$(b).removeClass("active");$(a.target).addClass("active"),this._loadContent(a.target.id)},_p._loadContent=function(a){var b=this,c=document.getElementById("right-panel");$(c).hide(100,function(){c.className="",$(c).html("").addClass(a),$(c).show(300),"controls"===a?(b._loadControls(),b._addBindingsEventListeners()):b._createSettings(a)})},_p._createSettings=function(a){function b(){var a=this.getAttribute("data-option-name"),b=this.value;settings.setPropValue(a,b)}var c=settings.getAll(),d=document.getElementById("right-panel");for(var e in c)if(c.hasOwnProperty(e)){var f=c[e];if(f.settingsType===a){var g=$("div").html(f.niceName)[0];d.appendChild(g);var h=$("input")[0];switch(d.appendChild(h),h.type=f.inputType,f.inputType){case"range":h.min=f.minValue,h.max=f.maxValue,h.step=f.step,h.value=f.value;break;case"button":h.value=f.value}h.onmouseup=b,h.setAttribute("data-option-name",e)}}},_p._loadControls=function(){var a=document.getElementById("right-panel"),b=this._assignments.getList();for(var c in b){var d=$("div")[0];$(d).addClass("binding");var e=$("div")[0];$(e).html(c).addClass("action-name"),d.appendChild(e),e=$("div")[0],this._actionsList[c]=e,$(e).html(b[c]).addClass("key-name"),d.appendChild(e),a.appendChild(d)}},_p._addBindingsEventListeners=function(){var a=this;window.addEventListener("click",function(b){a._clickHandler.call(a,b)}),window.addEventListener("keydown",function(b){a._keydownHandler.call(a,b)}),this._assignments._addEventListener("changeAssignnment",function(b){a._changeAssignmentHandler.call(a,b)})},_p._removeEventListeners=function(){},_p._changeAssignmentHandler=function(a){this._actionsList[a].innerHTML=this._assignments.getList()[a]},_p._clickHandler=function(a){var b=document.getElementsByClassName("key-name active")[0];if(b&&$(b).removeClass("active"),$(a.target).hasClass("key-name")){var c=a.target.previousElementSibling.innerHTML;this._assignments.setActiveBinding(c),$(a.target).addClass("active")}},_p._keydownHandler=function(a){var b=document.getElementsByClassName("key-name active")[0];b?(this._assignments.tryBind(a.keyCode),a.preventDefault()):user.actions.Settings&&(this._removeEventListeners(),$(document.getElementById("settings")).remove(),$(document.getElementById("settings-style")).remove())},User.prototype._setEventListeners=function(){var a=this;window.addEventListener("keydown",function(b){var c=settings.getAssignments(),d=c.getActionFromCode(b.keyCode);d&&(a.actions[d]=!0),a.keys[b.keyCode]=!0}),window.addEventListener("keyup",function(b){var c=settings.getAssignments(),d=c.getActionFromCode(b.keyCode);d&&(a.actions[d]=!1),a.keys[b.keyCode]=!1}),window.addEventListener("blur",function(){a.keys={}})},World.prototype._loadData=function(){var a=this;loadJSON("data/castle.json").then(function(b){a.width=b.width,a.height=b.height,a.outputTileWidth=b.tilewidth,a.outputTileHeight=b.tileheight,a.tileFactor=a.outputTileHeight/a.outputTileWidth,a._layers=b.layers,a._createMapFromImportedData(b.layers);for(var c=0;c<b.tilesets.length;c++)a._tileSets.push(new TileSet(b.tilesets[c]));a._createStaticObjects(b,a),a._trigger("loaded")})},World.prototype._createMapFromImportedData=function(a){this._map=createArray(a.length,this.width,this.width);for(var b=0;b<a.length;b++){var c=a[b].data;if(c)for(var d=this.width,e=0;e<c.length;e++){var f=e%d,g=e/d|0;this._map[b][f][g]=c[e]}}},World.prototype.drawLayers=function(){for(var a=this._calculateMapEdges(),b=0;b<this._layers.length;b++){var c=this._layers[b];if(c.data)for(var d=a.startY;d<a.endY;d++)for(var e=a.endX-1;e>=a.startX;e--){var f=relativate(e*this.outputTileWidth,d*this.outputTileHeight),g=f.x,h=f.y;this._tileSets[0].draw(g,h,c.data[this.width*d+e])}}},World.prototype._calculateMapEdges=function(){var a=Math.floor((game._player.x-game._board.width/2)/this.outputTileWidth-1),b=Math.floor((game._player.y-game._board.height/2)/this.outputTileHeight-1),c=Math.ceil((game._player.x+game._board.width/2)/this.outputTileWidth+1),d=Math.ceil((game._player.y+game._board.height/2)/this.outputTileHeight+1);return{startX:Math.max(0,a),startY:Math.max(0,b),endX:Math.min(this.width,c),endY:Math.min(this.height,d)}},World.prototype.drawObjects=function(){this._objectsOnScreen=[],this._objects.sort(function(a,b){return a.y+a.height-(b.y+b.height)===0?a.x-b.x:a.y+a.height-(b.y+b.height)});for(var a=0;a<this._objects.length;a++){this._objectsOnScreen.push(this._objects[a]);var b=this._objects[a];b.draw()}},World.prototype._createStaticObjects=function(a){var b,c=[];for(b=0;b<a.tilesets.length;b++){var d=a.tilesets[b];if(!d.hasOwnProperty("image"))for(var e in d.tiles)c[+e+ +d.firstgid]=d.tiles[e].image}for(b=0;b<a.layers.length;b++){var f=a.layers[b];if(f.objects)for(var g=0;g<f.objects.length;g++){var h=f.objects[g],i=new GameObject(this,{url:c[h.gid],x:h.x,y:h.y-h.height,visible:h.visible,name:h.name});this.addObject(i)}}},World.prototype.addObject=function(a){this._objects.push(a)},TileSet.prototype.load=function(){if(this.image)this.rows=this.imageheight/this.tileheight,this.cols=this.imagewidth/this.tilewidth,this.img=new Image,this.img.src=this.image;else{this.images=[];for(var a in this.tiles){var b=new Image;b.src=this.tiles[a].image,this.images.push(b)}}},TileSet.prototype.draw=function(a,b,c){c-=this.firstgid;var d=c%this.cols*this.tilewidth,e=(c/this.cols|0)*this.tileheight;ctx.drawImage(this.img,d,e,this.tilewidth,this.tileheight,a,b,this.tilewidth,this.tileheight)};